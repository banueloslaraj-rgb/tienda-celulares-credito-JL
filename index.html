<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Celulares JL - Venta de Celulares a Cr√©dito con Sistema MDM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script type="module">
        // Importar Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, deleteDoc, onSnapshot, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDVs8vcmrbiQHvVKoKCrbaM4qJiryGvYx4",
            authDomain: "celularesjl-c86dc.firebaseapp.com",
            projectId: "celularesjl-c86dc",
            storageBucket: "celularesjl-c86dc.firebasestorage.app",
            messagingSenderId: "641672688811",
            appId: "1:641672688811:web:c6f97887d0ba53231c73ee"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Hacer disponible globalmente
        window.firebaseApp = app;
        window.firestoreDB = db;
        window.firebaseModules = { 
            collection, addDoc, getDocs, updateDoc, doc, deleteDoc, onSnapshot, setDoc 
        };
        
        console.log("‚úÖ Firebase configurado correctamente");
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary: #3498db;
            --secondary: #2c3e50;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
        }
        
        body {
            background-color: #f9f9f9;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        .section-padding {
            padding: 80px 0;
        }
        
        .section-title {
            text-align: center;
            margin-bottom: 50px;
            font-size: 2.5rem;
            color: var(--secondary);
            position: relative;
        }
        
        .section-title:after {
            content: '';
            display: block;
            width: 80px;
            height: 4px;
            background: var(--primary);
            margin: 15px auto;
            border-radius: 2px;
        }
        
        .btn {
            display: inline-block;
            background-color: var(--primary);
            color: white;
            padding: 12px 25px;
            border-radius: 5px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .btn:hover {
            background-color: #2980b9;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .btn-accent {
            background-color: var(--accent);
        }
        
        .btn-accent:hover {
            background-color: #c0392b;
        }
        
        .btn-success {
            background-color: var(--success);
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        
        .btn-outline:hover {
            background-color: var(--primary);
            color: white;
        }

        .btn-sm {
            padding: 8px 15px;
            font-size: 0.85rem;
        }

        /* Panel de Administraci√≥n MDM */
        .admin-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 80px 0;
        }

        .admin-login {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 400px;
            margin: 0 auto;
        }

        .admin-login h2 {
            color: var(--secondary);
            text-align: center;
            margin-bottom: 30px;
        }

        .admin-panel {
            display: none;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .admin-header {
            background: var(--secondary);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px;
            background: var(--light);
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
            display: block;
        }

        .stat-label {
            color: var(--secondary);
            font-size: 0.9rem;
        }

        .admin-content {
            padding: 30px;
        }

        .device-list {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        .device-header {
            background: var(--light);
            padding: 20px;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
            gap: 15px;
            font-weight: bold;
            color: var(--secondary);
        }

        .device-item {
            padding: 20px;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
            gap: 15px;
            align-items: center;
            border-bottom: 1px solid #eee;
            color: #333;
        }

        .device-item:last-child {
            border-bottom: none;
        }

        .device-item:hover {
            background-color: #f8f9fa;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-active {
            background: #e8f5e8;
            color: var(--success);
        }

        .status-blocked {
            background: #ffeaea;
            color: var(--accent);
        }

        .status-pending {
            background: #fff3cd;
            color: var(--warning);
        }

        .status-android {
            background: #e8f4fd;
            color: #3498db;
        }

        .firebase-status {
            background: #2ecc71;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            margin-left: 10px;
        }

        .firebase-offline {
            background: #e74c3c;
        }

        .device-type-badge {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 5px;
        }

        /* ... (el resto del CSS permanece igual) ... */

    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <nav class="navbar">
                <div class="logo">
                    <i class="fas fa-mobile-alt"></i>
                    Celulares JL
                </div>
                <ul class="nav-links">
                    <li><a href="#inicio">Inicio</a></li>
                    <li><a href="#productos">Productos</a></li>
                    <li><a href="#credito">Cr√©dito</a></li>
                    <li><a href="#admin">Administraci√≥n MDM</a></li>
                    <li><a href="#contacto">Contacto</a></li>
                </ul>
                <a href="#credito" class="btn">Solicitar Cr√©dito</a>
            </nav>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero" id="inicio">
        <div class="container">
            <h1>Los Mejores Celulares a Cr√©dito con Sistema MDM</h1>
            <p>Adquiere el smartphone que siempre has querido con nuestras facilidades de pago. Sistema de administraci√≥n MDM integrado para tu seguridad.</p>
            <div class="hero-buttons">
                <a href="#productos" class="btn">Ver Cat√°logo</a>
                <a href="#credito" class="btn btn-outline">Calcular Cr√©dito</a>
            </div>
        </div>
    </section>

    <!-- Features -->
    <section class="features section-padding">
        <div class="container">
            <h2 class="section-title">¬øPor Qu√© Elegirnos?</h2>
            <div class="features-grid">
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h3>Sistema MDM Integrado</h3>
                    <p>Control total de dispositivos con nuestro sistema de Mobile Device Management. Bloqueo remoto en caso de impago.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-credit-card"></i>
                    </div>
                    <h3>Cr√©dito Accesible</h3>
                    <p>Aprobaci√≥n inmediata con documentos b√°sicos. Planes desde 6 hasta 24 meses con tasas competitivas.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-mobile-alt"></i>
                    </div>
                    <h3>Dispositivos Premium</h3>
                    <p>Trabajamos con las mejores marcas: Apple, Samsung, Xiaomi, Motorola y m√°s. Garant√≠a de 12 meses.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Productos -->
    <section class="products section-padding" id="productos">
        <div class="container">
            <h2 class="section-title">Cat√°logo de Productos</h2>
            <div class="products-filter">
                <button class="filter-btn active" data-filter="all">Todos</button>
                <button class="filter-btn" data-filter="apple">Apple</button>
                <button class="filter-btn" data-filter="samsung">Samsung</button>
                <button class="filter-btn" data-filter="xiaomi">Xiaomi</button>
                <button class="filter-btn" data-filter="motorola">Motorola</button>
            </div>
            <div class="products-grid" id="products-container">
                <!-- Los productos se cargar√°n aqu√≠ din√°micamente -->
            </div>
        </div>
    </section>

    <!-- Calculadora de Cr√©dito -->
    <section class="calculator section-padding" id="credito">
        <div class="container">
            <h2 class="section-title">Calcula Tu Cr√©dito</h2>
            <div class="calculator-container">
                <div class="calculator-form">
                    <form id="credit-form">
                        <div class="form-group">
                            <label for="product">Selecciona un producto</label>
                            <select id="product" required>
                                <option value="">Selecciona un celular</option>
                                <!-- Las opciones se llenar√°n din√°micamente -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="months">Plazo en meses</label>
                            <select id="months" required>
                                <option value="3">3 meses</option>
                                <option value="6">6 meses</option>
                                <option value="12" selected>12 meses</option>
                                <option value="18">18 meses</option>
                                <option value="24">24 meses</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="initial-payment">Pago inicial (opcional)</label>
                            <input type="number" id="initial-payment" placeholder="Ingresa el monto">
                        </div>
                        <button type="submit" class="btn">Calcular Cuota</button>
                    </form>
                </div>
                <div class="calculator-result" id="calculator-result">
                    <h3>Resumen de Financiamiento</h3>
                    <p>Selecciona un producto y completa el formulario para ver tu plan de pago personalizado.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Panel de Administraci√≥n MDM -->
    <section class="admin-section section-padding" id="admin">
        <div class="container">
            <h2 class="section-title" style="color: white;">Panel de Administraci√≥n MDM 
                <span id="firebase-status" class="firebase-status">Conectado a Firebase</span>
            </h2>
            
            <!-- Login para Administradores -->
            <div class="admin-login" id="admin-login">
                <h2>Acceso Administrativo MDM</h2>
                <form id="login-form">
                    <div class="form-group">
                        <label for="username">Usuario</label>
                        <input type="text" id="username" required placeholder="Ingresa tu usuario" value="">
                    </div>
                    <div class="form-group">
                        <label for="password">Contrase√±a</label>
                        <input type="password" id="password" required placeholder="Ingresa tu contrase√±a" value="">
                    </div>
                    <button type="submit" class="btn" style="width: 100%;">Acceder al Panel MDM</button>
                </form>
                <p style="text-align: center; margin-top: 20px; color: #666; font-size: 0.9rem;">
                    Credenciales de prueba: admin / 1234
                </p>
            </div>

            <!-- Panel de Administraci√≥n MDM -->
            <div class="admin-panel" id="admin-panel">
                <div class="admin-header">
                    <h2>Panel de Control MDM - Celulares JL 
                        <span id="firebase-panel-status" class="firebase-status">Firebase ‚úÖ</span>
                    </h2>
                    <button class="btn btn-outline" onclick="logoutAdmin()" style="color: white; border-color: white;">
                        <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
                    </button>
                </div>

                <div class="admin-stats">
                    <div class="stat-card">
                        <span class="stat-number" id="total-devices">0</span>
                        <span class="stat-label">Dispositivos Totales</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="active-devices">0</span>
                        <span class="stat-label">Dispositivos Activos</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="blocked-devices">0</span>
                        <span class="stat-label">Dispositivos Bloqueados</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="android-devices">0</span>
                        <span class="stat-label">Usan Android ID</span>
                    </div>
                </div>

                <div class="admin-content">
                    <h3 style="margin-bottom: 20px; color: var(--secondary);">Gesti√≥n de Dispositivos MDM</h3>
                    
                    <div class="device-list">
                        <div class="device-header">
                            <div>Cliente / Dispositivo</div>
                            <div>Identificador</div>
                            <div>Estado de Pago</div>
                            <div>Estado MDM</div>
                            <div>Acciones</div>
                        </div>
                        <div id="devices-list">
                            <!-- Los dispositivos se cargar√°n aqu√≠ din√°micamente -->
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 40px;">
                        <div>
                            <h4 style="margin-bottom: 15px; color: var(--secondary);">Registrar Nuevo Dispositivo</h4>
                            <form id="add-device-form">
                                <div class="form-group">
                                    <input type="text" id="client-name" placeholder="Nombre completo del cliente" required>
                                </div>
                                <div class="form-group">
                                    <input type="text" id="device-imei" placeholder="IMEI del dispositivo (15 d√≠gitos)" required maxlength="15">
                                </div>
                                <div class="form-group">
                                    <input type="text" id="device-model" placeholder="Modelo del dispositivo" required>
                                </div>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-plus"></i> Registrar Dispositivo
                                </button>
                            </form>
                        </div>
                        
                        <div>
                            <h4 style="margin-bottom: 15px; color: var(--secondary);">B√∫squeda R√°pida</h4>
                            <div class="form-group">
                                <input type="text" id="search-device" placeholder="Buscar por IMEI, Android ID o cliente..." 
                                       onkeyup="searchDevices()">
                            </div>
                            <div id="search-results" style="max-height: 200px; overflow-y: auto;">
                                <!-- Resultados de b√∫squeda -->
                            </div>
                            
                            <div style="margin-top: 20px;">
                                <button class="btn btn-outline" onclick="exportSalesData()" style="width: 100%;">
                                    <i class="fas fa-download"></i> Exportar Datos a Excel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Testimonios -->
    <section class="testimonials section-padding" id="testimonios">
        <div class="container">
            <h2 class="section-title">Lo Que Dicen Nuestros Clientes</h2>
            <div class="testimonials-grid">
                <div class="testimonial-card">
                    <div class="testimonial-text">
                        "Excelente servicio, me aprobaron el cr√©dito en menos de 24 horas y el tel√©fono lleg√≥ perfecto. El sistema MDM me da confianza."
                    </div>
                    <div class="testimonial-author">
                        <img src="https://randomuser.me/api/portraits/men/32.jpg" alt="Cliente" class="author-avatar">
                        <div class="author-info">
                            <h4>Roberto S√°nchez</h4>
                            <p>Cliente desde 2022</p>
                        </div>
                    </div>
                </div>
                <div class="testimonial-card">
                    <div class="testimonial-text">
                        "El proceso fue muy sencillo y las cuotas se ajustan a mi presupuesto. Definitivamente recomiendo Celulares JL por su transparencia."
                    </div>
                    <div class="testimonial-author">
                        <img src="https://randomuser.me/api/portraits/women/44.jpg" alt="Cliente" class="author-avatar">
                        <div class="author-info">
                            <h4>Mar√≠a Gonz√°lez</h4>
                            <p>Cliente desde 2023</p>
                        </div>
                    </div>
                </div>
                <div class="testimonial-card">
                    <div class="testimonial-text">
                        "Ten√≠a mal historial crediticio y en otras tiendas me hab√≠an rechazado. En Celulares JL me dieron una oportunidad y ahora tengo el tel√©fono que quer√≠a."
                    </div>
                    <div class="testimonial-author">
                        <img src="https://randomuser.me/api/portraits/men/67.jpg" alt="Cliente" class="author-avatar">
                        <div class="author-info">
                            <h4>Carlos Mendoza</h4>
                            <p>Cliente desde 2023</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer id="contacto">
        <div class="container">
            <div class="footer-content">
                <div class="footer-column">
                    <h3>Celulares JL</h3>
                    <p>Tu tienda de confianza para adquirir celulares a cr√©dito con sistema MDM integrado para tu seguridad.</p>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-facebook-f"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-whatsapp"></i></a>
                    </div>
                </div>
                <div class="footer-column">
                    <h3>Enlaces R√°pidos</h3>
                    <ul>
                        <li><a href="#inicio">Inicio</a></li>
                        <li><a href="#productos">Productos</a></li>
                        <li><a href="#credito">Cr√©dito</a></li>
                        <li><a href="#admin">Administraci√≥n MDM</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Contacto</h3>
                    <ul>
                        <li><i class="fas fa-phone"></i> +52 311 106 3251</li>
                        <li><i class="fas fa-envelope"></i> celularesJL@gmail.com</li>
                        <li><i class="fas fa-map-marker-alt"></i> Democrito #56, Tepic, Nayarit</li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Horario de Atenci√≥n</h3>
                    <ul>
                        <li>Lunes - Viernes: 9:30 AM - 8:00 PM</li>
                        <li>S√°bados: 10:00 AM - 6:00 PM</li>
                        <li>Domingos: 10:00 AM - 6:00 PM</li>
                    </ul>
                </div>
            </div>
            <div class="copyright">
                <p>&copy; 2024 Celulares JL. Todos los derechos reservados. | Sistema MDM Integrado</p>
            </div>
        </div>
    </footer>

    <script>
        // ========== DATOS DE PRODUCTOS ==========
        const products = [
            {
                id: 1,
                name: "iPhone 14 Pro",
                price: 1299,
                brand: "apple",
                image: "https://www.att.com.mx/dw/image/v2/BJKW_PRD/on/demandware.static/-/Sites-att-master/default/dw75e48dd6/images/Devices/Apple/Iphone%2014%20Pro/iPhone_14_Pro_Space_Black_PDP_Image_Position-1a_MXLA.jpg?sw=400&sh=400&sm=fit",
                description: "El √∫ltimo iPhone con Dynamic Island y c√°mara de 48MP.",
                features: ["Pantalla Super Retina XDR", "Chip A16 Bionic", "C√°mara Pro de 48 MP", "Hasta 28 horas de video"]
            },
            {
                id: 2,
                name: "Samsung Galaxy S23",
                price: 999,
                brand: "samsung",
                image: "https://images.unsplash.com/photo-1610945265064-0e34e5519bbf?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=60",
                description: "Potente smartphone Android con excelente c√°mara y rendimiento.",
                features: ["Pantalla Dynamic AMOLED 2X", "Snapdragon 8 Gen 2", "C√°mara de 50 MP", "Bater√≠a de 3900 mAh"]
            },
            {
                id: 3,
                name: "Google Pixel 7",
                price: 799,
                brand: "google",
                image: "https://cdn-files.kimovil.com/default/0007/85/thumb_684812_default_big.jpg",
                description: "Experiencia Android pura con la mejor c√°mara del mercado.",
                features: ["Pantalla OLED", "Tensor G2", "C√°mara de 50 MP", "Android 13"]
            },
            {
                id: 4,
                name: "OnePlus 11",
                price: 899,
                brand: "oneplus",
                image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR1xXbunCgiTx5bHPCn50HcWSe28_JjxqaaFg&s",
                description: "Rendimiento excepcional y carga ultrarr√°pida.",
                features: ["Pantalla Fluid AMOLED", "Snapdragon 8 Gen 2", "C√°mara Hasselblad", "Carga de 100W"]
            },
            {
                id: 5,
                name: "Xiaomi 13",
                price: 749,
                brand: "xiaomi",
                image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTwqPsP4l4FHGWiUO0tE_QHmof8_HjIHl3G18ApEhOTJuROT5iPedK3CytjmCkvA5PuNVs&usqp=CAU",
                description: "Excelente relaci√≥n calidad-precio con caracter√≠sticas premium.",
                features: ["Pantalla AMOLED", "Snapdragon 8 Gen 2", "C√°mara Leica", "Bater√≠a de 4500 mAh"]
            },
            {
                id: 6,
                name: "Motorola Edge 40 neo",
                price: 599,
                brand: "motorola",
                image: "https://i5.walmartimages.com.mx/gr/images/product-images/img_large/00084002325809L.jpg?odnHeight=612&odnWidth=612&odnBg=FFFFFF",
                description: "Pantalla curva y bater√≠a de larga duraci√≥n.",
                features: ["Pantalla pOLED 144Hz", "MediaTek Dimensity 7030", "C√°mara de 50 MP", "Bater√≠a de 5000 mAh"]
            }
        ];

        // ========== SISTEMA MDM CON FIREBASE ==========
        let devices = [];
        let firebaseReady = false;

        // Verificar estado de Firebase
        function checkFirebaseStatus() {
            if (window.firestoreDB) {
                firebaseReady = true;
                document.getElementById('firebase-status').textContent = 'Conectado a Firebase';
                document.getElementById('firebase-panel-status').textContent = 'Firebase ‚úÖ';
                console.log("‚úÖ Firebase conectado correctamente");
                
                // Cargar dispositivos autom√°ticamente si est√° logueado
                if (document.getElementById('admin-panel').style.display === 'block') {
                    loadDevicesList();
                }
            } else {
                firebaseReady = false;
                document.getElementById('firebase-status').textContent = 'Modo Local';
                document.getElementById('firebase-status').classList.add('firebase-offline');
                document.getElementById('firebase-panel-status').textContent = 'Modo Local ‚ö†Ô∏è';
                console.log("‚ö†Ô∏è Usando almacenamiento local");
            }
        }

        // ========== FUNCIONES FIREBASE CORREGIDAS ==========

        // Funci√≥n para guardar dispositivo en Firebase - ESTRUCTURA COMPATIBLE CON ANDROID CORREGIDA
        async function saveDeviceToFirebase(deviceData) {
            if (!firebaseReady) return null;
            
            try {
                // USAR EL IMEI/AndroidID COMO ID DEL DOCUMENTO
                const deviceRef = firebaseModules.doc(firestoreDB, "devices", deviceData.imei);
                
                // ESTRUCTURA COMPATIBLE CON LA APP ANDROID CORREGIDA
                await firebaseModules.setDoc(deviceRef, {
                    imei: deviceData.imei,
                    deviceType: deviceData.imei.startsWith("ANDROID_") ? "android_id" : "imei",
                    cleanImei: deviceData.imei.startsWith("ANDROID_") ? deviceData.imei.substring(8) : deviceData.imei,
                    model: deviceData.model,
                    status: "active",
                    clientName: deviceData.clientName,
                    paymentStatus: "al d√≠a",
                    lastPayment: new Date().toISOString().split('T')[0],
                    created: new Date().toISOString(),
                    lastUpdated: new Date().toISOString(),
                    brand: deviceData.brand || "Desconocido",
                    androidVersion: deviceData.androidVersion || "Desconocido"
                });
                
                console.log("‚úÖ Dispositivo guardado en Firebase con estructura compatible:", deviceData.imei);
                return deviceData.imei;
            } catch (error) {
                console.error("‚ùå Error guardando en Firebase:", error);
                return null;
            }
        }

        // Funci√≥n para cargar dispositivos desde Firebase
        async function loadDevicesFromFirebase() {
            if (!firebaseReady) return [];
            
            try {
                const querySnapshot = await firebaseModules.getDocs(
                    firebaseModules.collection(firestoreDB, "devices")
                );
                
                const firebaseDevices = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    firebaseDevices.push({ 
                        firebaseId: doc.id, 
                        clientName: data.clientName || 'Por asignar',
                        imei: data.imei || doc.id,
                        model: data.model || 'Desconocido',
                        status: data.status || 'active',
                        paymentStatus: data.paymentStatus || 'al d√≠a',
                        lastPayment: data.lastPayment || new Date().toISOString().split('T')[0],
                        created: data.created || new Date().toISOString(),
                        deviceType: data.deviceType || 'imei',
                        brand: data.brand || 'Desconocido',
                        androidVersion: data.androidVersion || 'Desconocido'
                    });
                });
                
                console.log("‚úÖ Dispositivos cargados desde Firebase:", firebaseDevices.length);
                return firebaseDevices;
            } catch (error) {
                console.error("‚ùå Error cargando desde Firebase:", error);
                return [];
            }
        }

        // Funci√≥n para actualizar dispositivo en Firebase
        async function updateDeviceInFirebase(deviceId, updates) {
            if (!firebaseReady) return false;
            
            try {
                const updateData = {
                    ...updates,
                    lastUpdated: new Date().toISOString()
                };
                
                await firebaseModules.updateDoc(
                    firebaseModules.doc(firestoreDB, "devices", deviceId),
                    updateData
                );
                
                console.log("‚úÖ Dispositivo actualizado en Firebase:", deviceId);
                return true;
            } catch (error) {
                console.error("‚ùå Error actualizando en Firebase:", error);
                return false;
            }
        }

        // Funci√≥n para eliminar dispositivo de Firebase
        async function deleteDeviceFromFirebase(deviceId) {
            if (!firebaseReady) return false;
            
            try {
                await firebaseModules.deleteDoc(
                    firebaseModules.doc(firestoreDB, "devices", deviceId)
                );
                console.log("‚úÖ Dispositivo eliminado de Firebase:", deviceId);
                return true;
            } catch (error) {
                console.error("‚ùå Error eliminando de Firebase:", error);
                return false;
            }
        }

        // ========== FUNCIONES MDM PRINCIPALES ==========

        async function blockDevice(deviceId) {
            try {
                const device = findDeviceById(deviceId);
                if (!device) {
                    alert('‚ùå Dispositivo no encontrado');
                    return;
                }
                
                if (confirm(`¬øEst√°s seguro de BLOQUEAR el dispositivo?\n\nCliente: ${device.clientName}\nID: ${device.imei}`)) {
                    // ACTUALIZAR EN FIREBASE CON LA ESTRUCTURA CORRECTA
                    if (device.firebaseId && firebaseReady) {
                        const success = await updateDeviceInFirebase(device.firebaseId, { 
                            status: 'blocked',
                            clientName: device.clientName
                        });
                        
                        if (!success) {
                            alert('‚ö†Ô∏è No se pudo actualizar en Firebase. Verifica la conexi√≥n.');
                            return;
                        }
                    }
                    
                    // Tambi√©n actualizar localmente
                    device.status = 'blocked';
                    saveToLocalStorage();
                    await loadDevicesList();
                    updateStats();
                    
                    alert(`üìµ DISPOSITIVO BLOQUEADO\n\nCliente: ${device.clientName}\nID: ${device.imei}\n\nEl dispositivo se bloquear√° autom√°ticamente en la app Android.`);
                }
            } catch (error) {
                console.error('Error bloqueando dispositivo:', error);
                alert('‚ùå Error al bloquear el dispositivo');
            }
        }

        async function unblockDevice(deviceId) {
            try {
                const device = findDeviceById(deviceId);
                if (!device) {
                    alert('‚ùå Dispositivo no encontrado');
                    return;
                }
                
                if (confirm(`¬øEst√°s seguro de DESBLOQUEAR el dispositivo?\n\nID: ${device.imei}`)) {
                    // ACTUALIZAR EN FIREBASE CON LA ESTRUCTURA CORRECTA
                    if (device.firebaseId && firebaseReady) {
                        const success = await updateDeviceInFirebase(device.firebaseId, { 
                            status: 'active'
                        });
                        
                        if (!success) {
                            alert('‚ö†Ô∏è No se pudo actualizar en Firebase. Verifica la conexi√≥n.');
                            return;
                        }
                    }
                    
                    // Tambi√©n actualizar localmente
                    device.status = 'active';
                    saveToLocalStorage();
                    await loadDevicesList();
                    updateStats();
                    
                    alert(`‚úÖ DISPOSITIVO DESBLOQUEADO\n\nID: ${device.imei}\n\nEl dispositivo se desbloquear√° autom√°ticamente en la app Android.`);
                }
            } catch (error) {
                console.error('Error desbloqueando dispositivo:', error);
                alert('‚ùå Error al desbloquear el dispositivo');
            }
        }

        // ========== C√ìDIGO PRINCIPAL ==========

        document.addEventListener('DOMContentLoaded', function() {
            const productsContainer = document.getElementById('products-container');
            const productSelect = document.getElementById('product');
            const filterButtons = document.querySelectorAll('.filter-btn');
            
            // Verificar estado de Firebase
            setTimeout(checkFirebaseStatus, 1000);
            
            // Funci√≥n para renderizar productos
            function renderProducts(filter = 'all') {
                productsContainer.innerHTML = '';
                
                const filteredProducts = filter === 'all' 
                    ? products 
                    : products.filter(product => product.brand === filter);
                
                filteredProducts.forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.className = 'product-card';
                    productCard.innerHTML = `
                        <div style="position: relative;">
                            <img src="${product.image}" alt="${product.name}" class="product-img">
                            <span class="product-badge">Nuevo</span>
                        </div>
                        <div class="product-info">
                            <h3 class="product-title">${product.name}</h3>
                            <p class="product-price">$${product.price}</p>
                            <p class="product-description">${product.description}</p>
                            <ul class="product-features">
                                ${product.features.map(feature => `<li><i class="fas fa-check"></i> ${feature}</li>`).join('')}
                            </ul>
                            <button class="btn btn-accent" data-product-id="${product.id}">Financiar Ahora</button>
                        </div>
                    `;
                    productsContainer.appendChild(productCard);
                });
            }
            
            // Llenar selector de productos en el formulario
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = `${product.name} - $${product.price}`;
                productSelect.appendChild(option);
            });
            
            // Renderizar todos los productos inicialmente
            renderProducts();
            
            // Manejar filtros de productos
            filterButtons.forEach(button => {
                button.addEventListener('click', function() {
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    renderProducts(this.getAttribute('data-filter'));
                });
            });
            
            // Manejar el formulario de c√°lculo de cr√©dito
            document.getElementById('credit-form').addEventListener('submit', function(e) {
                e.preventDefault();
                calculateCredit();
            });
            
            // Manejar clic en botones de financiar
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('btn-accent')) {
                    const productId = e.target.getAttribute('data-product-id');
                    document.getElementById('product').value = productId;
                    document.getElementById('credito').scrollIntoView({ behavior: 'smooth' });
                }
            });

            // ========== SISTEMA DE LOGIN MDM - CORREGIDO ==========
            document.getElementById('login-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                // CREDENCIALES SEGURAS - NO MOSTRAR EN ALERTA
                const ADMIN_CREDENTIALS = {
                    username: 'admin',
                    password: '1234'
                };
                
                if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
                    document.getElementById('admin-login').style.display = 'none';
                    document.getElementById('admin-panel').style.display = 'block';
                    await loadAdminPanel();
                } else {
                    alert('‚ùå Usuario o contrase√±a incorrectos\n\nContacta al administrador del sistema.');
                }
            });

            // ========== FORMULARIO AGREGAR DISPOSITIVO ==========
            document.getElementById('add-device-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                const clientName = document.getElementById('client-name').value;
                const imei = document.getElementById('device-imei').value;
                const model = document.getElementById('device-model').value;
                
                // Validar IMEI (15 d√≠gitos)
                if (imei.length !== 15 || !/^\d+$/.test(imei)) {
                    alert('‚ùå El IMEI debe tener exactamente 15 d√≠gitos num√©ricos');
                    return;
                }
                
                // Verificar si el IMEI ya existe
                const existingDevice = devices.find(d => d.imei === imei);
                if (existingDevice) {
                    alert(`‚ùå El IMEI ${imei} ya est√° registrado\nCliente: ${existingDevice.clientName}`);
                    return;
                }
                
                const newDevice = {
                    clientName: clientName,
                    imei: imei,
                    model: model,
                    status: "active",
                    paymentStatus: "al d√≠a",
                    lastPayment: new Date().toISOString().split('T')[0],
                    created: new Date().toISOString()
                };
                
                // Intentar guardar en Firebase
                const firebaseId = await saveDeviceToFirebase(newDevice);
                
                if (firebaseId) {
                    // √âxito en Firebase
                    newDevice.firebaseId = firebaseId;
                    devices.push(newDevice);
                    alert(`‚úÖ Dispositivo registrado exitosamente\n\nCliente: ${clientName}\nIMEI: ${imei}\nModelo: ${model}\n\nEl dispositivo aparecer√° en la app Android autom√°ticamente.`);
                } else {
                    // Fallback a localStorage
                    newDevice.id = 'local_' + Date.now();
                    devices.push(newDevice);
                    saveToLocalStorage();
                    alert(`‚ö†Ô∏è Dispositivo registrado en modo local\n\nCliente: ${clientName}\nIMEI: ${imei}\n\nFirebase no est√° disponible, usando almacenamiento local.`);
                }
                
                await loadDevicesList();
                updateStats();
                document.getElementById('add-device-form').reset();
            });
        });

        // ========== FUNCIONES MDM COMPLEMENTARIAS ==========

        async function loadAdminPanel() {
            await loadDevicesList();
            updateStats();
        }

        async function loadDevicesList() {
            try {
                // Intentar cargar desde Firebase primero
                const firebaseDevices = await loadDevicesFromFirebase();
                
                if (firebaseDevices.length > 0) {
                    devices = firebaseDevices;
                    console.log("üì± Dispositivos cargados desde Firebase");
                } else {
                    // Fallback a localStorage
                    devices = loadFromLocalStorage();
                    console.log("üì± Dispositivos cargados desde almacenamiento local");
                    
                    // Migrar datos locales a Firebase si es posible
                    if (devices.length > 0 && firebaseReady) {
                        await migrateToFirebase(devices);
                    }
                }
                
                renderDevicesList();
                updateStats();
            } catch (error) {
                console.error("Error cargando dispositivos:", error);
                devices = loadFromLocalStorage();
                renderDevicesList();
                updateStats();
            }
        }

        function renderDevicesList() {
            const devicesList = document.getElementById('devices-list');
            devicesList.innerHTML = '';
            
            if (devices.length === 0) {
                devicesList.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: #666;">
                        <i class="fas fa-mobile-alt" style="font-size: 3rem; margin-bottom: 15px; color: #ddd;"></i>
                        <p>No hay dispositivos registrados a√∫n.</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">Usa el formulario para registrar el primer dispositivo.</p>
                    </div>
                `;
                return;
            }
            
            devices.forEach(device => {
                const isAndroidId = device.imei.startsWith("ANDROID_");
                const displayId = isAndroidId ? device.imei.substring(8) : device.imei;
                
                const deviceItem = document.createElement('div');
                deviceItem.className = 'device-item';
                deviceItem.innerHTML = `
                    <div>
                        <strong style="color: #2c3e50;">${device.clientName}</strong><br>
                        <small style="color: #666;">${device.model}</small>
                        ${isAndroidId ? '<span class="device-type-badge status-android">Android ID</span>' : '<span class="device-type-badge status-active">IMEI</span>'}
                    </div>
                    <div style="font-family: monospace; font-weight: 600; color: #2c3e50;">
                        ${displayId}
                    </div>
                    <div>
                        <span class="status-badge ${device.paymentStatus === 'al d√≠a' ? 'status-active' : 'status-blocked'}">
                            ${device.paymentStatus}
                        </span>
                    </div>
                    <div>
                        <span class="status-badge ${device.status === 'active' ? 'status-active' : 'status-blocked'}">
                            ${device.status === 'active' ? 'ACTIVO' : 'BLOQUEADO'}
                        </span>
                    </div>
                    <div>
                        ${device.status === 'active' 
                            ? `<button class="btn btn-accent btn-sm" onclick="blockDevice('${device.firebaseId || device.id}')">
                                  <i class="fas fa-lock"></i> Bloquear
                               </button>`
                            : `<button class="btn btn-success btn-sm" onclick="unblockDevice('${device.firebaseId || device.id}')">
                                  <i class="fas fa-unlock"></i> Desbloquear
                               </button>`
                        }
                        <button class="btn btn-outline btn-sm" onclick="deleteDevice('${device.firebaseId || device.id}')" style="margin-left: 5px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                devicesList.appendChild(deviceItem);
            });
        }

        function updateStats() {
            const total = devices.length;
            const active = devices.filter(d => d.status === 'active').length;
            const blocked = devices.filter(d => d.status === 'blocked').length;
            const androidDevices = devices.filter(d => d.imei.startsWith("ANDROID_")).length;
            
            document.getElementById('total-devices').textContent = total;
            document.getElementById('active-devices').textContent = active;
            document.getElementById('blocked-devices').textContent = blocked;
            document.getElementById('android-devices').textContent = androidDevices;
        }

        async function deleteDevice(deviceId) {
            try {
                const device = findDeviceById(deviceId);
                if (!device) {
                    alert('‚ùå Dispositivo no encontrado');
                    return;
                }
                
                if (confirm(`¬øEst√°s seguro de ELIMINAR este dispositivo?\n\nCliente: ${device.clientName}\nID: ${device.imei}\n\nEsta acci√≥n no se puede deshacer.`)) {
                    // Eliminar de Firebase si existe
                    if (device.firebaseId) {
                        await deleteDeviceFromFirebase(device.firebaseId);
                    }
                    
                    // Eliminar del array local
                    devices = devices.filter(d => (d.firebaseId || d.id) !== deviceId);
                    saveToLocalStorage();
                    await loadDevicesList();
                    updateStats();
                    
                    alert('‚úÖ Dispositivo eliminado exitosamente');
                }
            } catch (error) {
                console.error('Error eliminando dispositivo:', error);
                alert('‚ùå Error al eliminar el dispositivo');
            }
        }

        // FUNCI√ìN CORREGIDA - Buscar dispositivo por ID
        function findDeviceById(deviceId) {
            return devices.find(d => {
                // Buscar por firebaseId O por id local
                const idToCompare = d.firebaseId || d.id;
                return idToCompare === deviceId;
            });
        }

        function searchDevices() {
            const searchTerm = document.getElementById('search-device').value.toLowerCase();
            const results = devices.filter(device => 
                device.clientName.toLowerCase().includes(searchTerm) || 
                device.imei.toLowerCase().includes(searchTerm) ||
                device.model.toLowerCase().includes(searchTerm)
            );
            
            const resultsDiv = document.getElementById('search-results');
            if (searchTerm.length > 0 && results.length > 0) {
                resultsDiv.innerHTML = results.map(device => `
                    <div style="padding: 10px; border-bottom: 1px solid #eee; cursor: pointer;" 
                         onclick="document.getElementById('search-device').value='${device.imei}'; document.getElementById('search-results').innerHTML='';">
                        <strong>${device.clientName}</strong> - ${device.model}<br>
                        <small>ID: ${device.imei} | Estado: <span class="${device.status === 'active' ? 'status-active' : 'status-blocked'}" style="padding: 2px 6px; border-radius: 10px; font-size: 0.7rem;">${device.status}</span></small>
                    </div>
                `).join('');
            } else if (searchTerm.length > 0) {
                resultsDiv.innerHTML = '<div style="padding: 10px; color: #666; text-align: center;">No se encontraron dispositivos</div>';
            } else {
                resultsDiv.innerHTML = '';
            }
        }

        function logoutAdmin() {
            document.getElementById('admin-panel').style.display = 'none';
            document.getElementById('admin-login').style.display = 'block';
            document.getElementById('login-form').reset();
        }

        // ========== FUNCIONES DE ALMACENAMIENTO LOCAL ==========

        function saveToLocalStorage() {
            localStorage.setItem('celularesjl_devices', JSON.stringify(devices));
        }

        function loadFromLocalStorage() {
            const localDevices = JSON.parse(localStorage.getItem('celularesjl_devices')) || [];
            return localDevices;
        }

        async function migrateToFirebase(localDevices) {
            console.log("üîÑ Migrando datos locales a Firebase...");
            let migratedCount = 0;
            
            for (const device of localDevices) {
                if (!device.firebaseId) {
                    const firebaseId = await saveDeviceToFirebase(device);
                    if (firebaseId) {
                        device.firebaseId = firebaseId;
                        migratedCount++;
                    }
                }
            }
            
            if (migratedCount > 0) {
                saveToLocalStorage();
                console.log(`‚úÖ ${migratedCount} dispositivos migrados a Firebase`);
            }
        }

        // ========== FUNCIONES DE EXPORTACI√ìN ==========

        function exportSalesData() {
            const salesData = devices.map(device => ({
                'Cliente': device.clientName,
                'Modelo': device.model,
                'Identificador': device.imei,
                'Tipo': device.imei.startsWith("ANDROID_") ? "Android ID" : "IMEI",
                'Estado MDM': device.status,
                'Estado de Pago': device.paymentStatus,
                '√öltimo Pago': device.lastPayment,
                'Fecha Registro': device.created
            }));
            
            let csv = 'Cliente,Modelo,Identificador,Tipo,Estado MDM,Estado de Pago,√öltimo Pago,Fecha Registro\n';
            salesData.forEach(row => {
                csv += `"${row.Cliente}","${row.Modelo}","${row.Identificador}","${row.Tipo}","${row['Estado MDM']}","${row['Estado de Pago']}","${row['√öltimo Pago']}","${row['Fecha Registro']}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', `dispositivos-celularesjl-${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            alert('‚úÖ Datos exportados exitosamente');
        }

        // ========== CALCULADORA DE CR√âDITO ==========

        function calculateCredit() {
            const productId = document.getElementById('product').value;
            const months = parseInt(document.getElementById('months').value);
            const initialPayment = parseFloat(document.getElementById('initial-payment').value) || 0;
            
            if (!productId) {
                alert('Por favor selecciona un producto');
                return;
            }
            
            const product = products.find(p => p.id == productId);
            const totalAmount = product.price - initialPayment;
            const interestRate = 0.15; // 15% de inter√©s anual
            const monthlyRate = interestRate / 12;
            
            // C√°lculo de cuota mensual usando f√≥rmula de amortizaci√≥n
            const monthlyPayment = totalAmount * (monthlyRate * Math.pow(1 + monthlyRate, months)) / (Math.pow(1 + monthlyRate, months) - 1);
            
            const resultDiv = document.getElementById('calculator-result');
            resultDiv.innerHTML = `
                <h3>Resumen de Financiamiento</h3>
                <div class="result-item">
                    <span>Producto:</span>
                    <span>${product.name}</span>
                </div>
                <div class="result-item">
                    <span>Precio:</span>
                    <span>$${product.price}</span>
                </div>
                <div class="result-item">
                    <span>Pago inicial:</span>
                    <span>$${initialPayment}</span>
                </div>
                <div class="result-item">
                    <span>Plazo:</span>
                    <span>${months} meses</span>
                </div>
                <div class="result-item">
                    <span>Tasa de inter√©s:</span>
                    <span>${(interestRate * 100).toFixed(1)}% anual</span>
                </div>
                <div class="result-item">
                    <span>Cuota mensual:</span>
                    <span>$${monthlyPayment.toFixed(2)}</span>
                </div>
                <div class="result-item">
                    <span>Total a pagar:</span>
                    <span>$${(monthlyPayment * months).toFixed(2)}</span>
                </div>
                <div class="result-item">
                    <span>Intereses:</span>
                    <span>$${((monthlyPayment * months) - totalAmount).toFixed(2)}</span>
                </div>
                <div class="result-total">
                    <span>Total financiado:</span>
                    <span>$${totalAmount.toFixed(2)}</span>
                </div>
                <button class="btn" style="margin-top: 20px; width: 100%;" onclick="saveSale({
                    product: '${product.name}',
                    price: ${product.price},
                    months: ${months},
                    initialPayment: ${initialPayment},
                    monthlyPayment: ${monthlyPayment.toFixed(2)},
                    totalAmount: ${totalAmount.toFixed(2)}
                })">Solicitar Este Cr√©dito</button>
            `;
        }

        // Funci√≥n para guardar ventas
        async function saveSale(saleData) {
            console.log("üí≥ Venta procesada:", saleData);
            alert('¬°Cr√©dito solicitado exitosamente! Nos pondremos en contacto contigo para finalizar el proceso.');
            
            // Guardar en Firebase si est√° configurado
            if (firebaseReady) {
                try {
                    await firebaseModules.addDoc(
                        firebaseModules.collection(firestoreDB, "sales"),
                        {
                            ...saleData,
                            timestamp: new Date().toISOString(),
                            status: "pending"
                        }
                    );
                    console.log("‚úÖ Venta guardada en Firebase");
                } catch (error) {
                    console.error("‚ùå Error guardando venta en Firebase:", error);
                }
            }
        }
    </script>
</body>
</html>
